---
title: "20201023-p8133_computingassignment_jsg2145"
author: "Jared Garfinkel"
date: "10/23/2020"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(viridis)
knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	message = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
theme_set(theme_minimal() + theme(legend.position = "bottom"))
```

# Question 1

## Part a

```{r typeIerror}
typeIerr = function(n = 10000) {
  sim_dat = rbinom(n, 20, .25)
  output = NULL
  
  for (i in 1:n) {
    if (sim_dat[[i]] > 5) {
      output = rbind(output, sim_dat[[i]])
    }
  }
  
  typeIerror = length(output)/n
  return(typeIerror)
}

typeIerror = typeIerr()
```

The type I error rate under the null, response rate = 0.25, is `r typeIerror`.

```{r}
output = NULL
pow = function(n = 10000) {
  sim_dat = rbinom(n, 20, .4)
  
  for (i in 1:n) {
    if (sim_dat[[i]] > 5) {
      output = rbind(output, sim_dat[[i]])
    }
  }
  
  power = nrow(output)/n
  return(power)
}

power = pow()
```

The power under the alternative, response rate = 0.4, is `r power`.

```{r}
# The expected sample size is equal to 20 times the proportion of times the futility trial threshold is not reached plus 71 times the proportion of times the futility trial threshold is reached

exp_ss = 20*typeIerror + 71*(1-typeIerror)
```

The expected sample size under these simulations is `r exp_ss`, or `r ceiling(exp_ss)`.

## Part b

```{r}
gonogo = function(stage1, stage2, null, alt, n1, n2) {
  res = vector(mode = "list", length = stage1)
  for(i in 1:stage1) {
    for(j in 1:stage2){
      res[[c(i,j)]] = bind_cols("n1_response" = i, "n2_response" = j)
    }
    res[[i]] = map(res[[i]], ~bind_rows(.))
  }

  sum_df = bind_rows(res) %>% 
    mutate(errorI = dbinom(n1_response, stage1, null) * dbinom(n2_response, stage2, null),
           power = dbinom(n1_response, stage1, alt) * dbinom(n2_response, stage2, alt)) %>%
    filter(n1_response > n1-1,
           n1_response + n2_response > n2-1) %>% 
    summarize(sum_error = sum(errorI),
              sum_power = sum(power))
  
  return(sum_df)
}
```

### Expected number of drugs identified to be effective

```{r}
sum_df = gonogo(stage1 = 20, stage2 = 51, null = .25, alt = 0.4, n1 = 6, n2 = 24)
```

The type I error rate under the null is `r round(pull(sum_df, sum_error), 4)`.

The power under the alternative is `r round(pull(sum_df, sum_power), 4)`


The expected number of drugs given a go decision is the number of drugs that work times the power (the probability of rejecting the null under the alternative) plus the number of drugs that don't work times the type I error rate (the probability of rejecting the null when the null is true).

```{r}
exp_godrug = 5*pull(sum_df, sum_power) + 95*pull(sum_df, sum_error)
```

So the expected number of drugs given a go decision can be calculated to be `r round(exp_godrug, 4)` or `r ceiling(exp_godrug)`.

The expected number of patients enrolled to the trial is the number of expected patients in each trial times 100.

### Expected total number of patients enrolled to the 100 trials

The expected number of patients in each trial is the size of the futility trial times the type I error plus the size of the two-stage trial when the futility threshold is reached.

```{r}
exp_ssnull = 20*pbinom(5, 20, .25) + 71*(1-pbinom(5, 20, .25))
exp_ssalt = 20*pbinom(5, 20, .4) + 71*(1-pbinom(5, 20, .4))
exp_ss2 = 5/100*exp_ssalt + 95/100*exp_ssnull
```

The expected sample size of each trial is `r round(exp_ss2, 4)` or `r ceiling(exp_ss2)`.

So, the expected number of patients for all trials is about 4077.

### Expected number of patients not having an MRI response among the enrolled.


The number of patients expected to not have an MRI response among the enrolled will be the number of patients enrolled in each trial times the true response rate for the drug in that trial.

```{r}
norespratenull = 95 * .25 * exp_ssnull
norespratealt = 5 * .4 * exp_ssalt
norespratetot = norespratenull + norespratealt
```

The number of patients expected not to have a response is `r norespratetot`.

## Part c

### Expected number of drugs identified to be effective

```{r}
fixed = function(n, go, null, alt) {
  errorI = NULL
  power = NULL
  res = NULL
  for(i in 1:n) {
    errorI[[i]] = dbinom(i, n, null)
    power[[i]] = dbinom(i, n, alt)
    res[[i]] = bind_cols("i" = i, "errorI" = errorI[[i]], "power" = power[[i]])
  }

  fixed_df = res %>% 
    bind_rows() %>% 
    filter(i > go - 1) %>%
    summarize(sum_error = sum(errorI),
              sum_power = sum(power))
  
  return(fixed_df)
}
```

```{r}
fixed_df = fixed(n = 62, go = 22, null = 0.25, alt = 0.4)
fixed_df
```

```{r}
exp_eff = 5*pull(fixed_df, sum_power) + 95 * pull(fixed_df, sum_error)
```

The expected number of drugs to be considered effective will be `r round(exp_eff, 4)` or `r ceiling(exp_eff)`.

### Expected total number of patients enrolled to the 100 trials

The expected number of patients in the trial is 62 x 100 since there are always the same number of patients enrolled in each trial in a fixed design study.

There are 6200 patients enrolled in the fixed design study.

### Expected number of patients not having an MRI response among the enrolled.

```{r}
norespratenull2 = 95 * .25 * 62
norespratealt2 = 5 * .4 * 62
norespratetot2 = norespratenull2 + norespratealt2
```

The expected number of patients with no response is `r norespratetot2` in the fixed design study. Compare to `r norespratetot` in the two-stage design.

# Question 2

```{r}
output = vector(mode = "list", length = 20)
for (i in 1:20) {
  for (j in 1:51) {
    output[[c(i, j)]] = bind_cols("n1_response" = i, "n2_response" = j)
    output[[c(i, j)]]$x = list(seq(from = 0.01, to = 0.4, by = 0.003))
  }
  output[[i]] = map(output[[i]], ~bind_rows(.))
}


output = bind_rows(output) %>% 
  unnest(x) %>% 
  nest(x)

# output %>% 
#   unnest() %>% 
#   unnest(x)
```

```{r}
goutput = output %>% 
  filter(n1_response > 5,
         n1_response + n2_response > 23)
```



```{r, eval = FALSE}
# head(output)
prior = function(df = output, null = 0.25, stage1n = 20, stage2n = 71, n1 = 6, n2 = 24) {
  res = df %>% 
    unnest(x) %>% 
    mutate(pE1 = dbeta(null, n1_response/stage1n, (stage1n-n1_response)/stage1n),
           pE2 = dbeta(null, (n1_response+n2_response)/stage2n, (stage2n-n1_response-n2_response)/stage2n),
           pE = pE1 * pE2,
           pS = dbeta(null+x, 25, 75)) %>% 
    filter(n1_response > n1-1,
           n1_response + n2_response > n2-1)
  return(res)
}
res = prior()
res %>% 
  filter(pE>pS) %>% 
  group_by(x) %>% 
  mutate(alpha = 1 - length(x)/nrow(goutput)) %>% 
  select(x, alpha) %>% 
  distinct() %>% 
  filter(alpha < .21)


# x = seq(from = 0.01, to = .4, by = .003)
# output %>% 
#   mutate(pS1 = dbeta(.25+x, 25, 75),
#          pS2 = dbeta(.25+x, 25, 75)
```

```{r}
prior = function(df = output, null = 0.25, stage1n = 20, stage2n = 71, n1 = 6, n2 = 24) {
  res = df %>% 
    unnest(data) %>% 
    mutate(pE1 = dbeta(null, n1_response/stage1n, (stage1n-n1_response)/stage1n),
           pE2 = dbeta(null, (n1_response+n2_response)/stage2n, (stage2n-n1_response-n2_response)/stage2n),
           pE = pE1 * pE2,
           pS = dbeta(null+x, 25, 75)) %>% 
    filter(n1_response > n1-1,
           n1_response + n2_response > n2-1)
  
  res  = res %>% 
    filter(pE>pS) %>% 
    group_by(x) %>% 
    mutate(alpha = 1 - length(x)/nrow(goutput)) %>% 
    select(x, alpha) %>% 
    distinct() %>% 
    filter(alpha < .21)
  return(res)
}
res = prior()
```


According to my calculations, a delta of 0.133 and an alpha of approximately 0.154 will result in a go decision when the 1st stage trial has a response rate equal to or greater than 6.    

```{r}
set.seed(1)
n_sim = 10e5
sum(rbeta(n_sim, shape1 = 6.5, shape2 = 15.5) > (rbeta(n_sim, shape1 = 25, shape2 = 75) + 0.133)) / n_sim
sum(rbeta(n_sim, shape1 = 5.5, shape2 = 16.5) > (rbeta(n_sim, shape1 = 25, shape2 = 75) + 0.133)) / n_sim
```
A simulation confirms that when the response rate is 6, the alpha is greater than .154, and when the response rate is 5, the alpha is less than 0.154.

# Question 3

```{r}
output1 = vector(mode = "list", length = 20)
for(i in 1:20) {
  output1[[i]] = bind_cols("n1_response" = i)
  output1[[i]]$x = list(seq(from = 0.01, to = 0.4, by = 0.003))
}

output1 = bind_rows(output1) %>% 
  unnest(x) %>% 
  nest(x)

goutput1 = output1 %>% 
  filter(n1_response > 5)
```


```{r}
output2 = vector(mode = "list", length = 400)
for (i in 1:20) {
  for (j in 1:51) {
    output2[[c(i, j)]] = bind_cols("n1_response" = i, "n2_response" = j)
    output2[[c(i, j)]]$x = list(seq(from = 0.01, to = 0.4, by = 0.003))
  }
  output2[[i]] = map(output2[[i]], ~bind_rows(.))
}


output2 = bind_rows(output2) %>% 
  unnest(x) %>% 
  nest(x)

goutput2 = output2 %>% 
  filter(n1_response > 5,
         (n1_response + n2_response) > 11)
```


```{r}
output3 = vector(mode = "list", length = 8000)
for (i in 1:20) {
  for (j in 1:20) {
    output3[[c(i, j)]] = bind_cols("n1_response" = i, "n2_response" = j)
    output3[[c(i, j)]]$k = list(seq(from = 1, to = 20))
    output3[[c(i, j)]]$x = list(seq(from = .01, to = 0.4, by = 0.003))
  }
  output3[[i]] = map(output3[[i]], ~bind_rows(.))
}

output3 = bind_rows(output3) %>% 
  rename("n3_response" = k) %>% 
  unnest(n3_response) %>% 
  unnest(x) %>% 
  nest(x)

goutput3 = output3 %>% 
  filter(n1_response > 5,
         (n1_response + n2_response) > 11,
         (n1_response + n2_response + n3_response) > 17)
```


```{r}
output4 = vector(mode = "list", length = 88000)
for (i in 1:20) {
  for(j in 1:20) {
    output4[[c(i, j)]] = bind_cols("n1_response" = i, "n2_response" = j)
    output4[[c(i, j)]]$k = list(seq(from = 1, to = 20))
    output4[[c(i, j)]]$l = list(seq(from = 1, to = 11))
    output4[[c(i, j)]]$x = list(seq(from = .01, to = 0.4, by = 0.003))
  }
  output4[[i]] = map(output4[[i]], ~bind_rows(.))
}

output4 = bind_rows(output4) %>% 
  rename("n3_response" = k,
         "n4_response" = l) %>%
  unnest(n3_response) %>% 
  unnest(n4_response) %>% 
  unnest(x) %>% 
  nest(x)

goutput4 = output4 %>% 
  filter(n1_response > 5,
         (n1_response + n2_response) > 11,
         (n1_response + n2_response + n3_response) > 17,
         (n1_response + n2_response + n3_response + n4_response) > 23)
```


```{r, echo = FALSE, eval = FALSE}
goutput2 = vector(mode = "list", length = 4)
goutput2[[1]] = output2 %>% 
  select(n1_response) %>% 
  filter(n1_response > 5) %>% 
  distinct()
goutput2[[2]] = output2 %>% 
  select(n1_response, n2_response) %>% 
  filter(n1_response > 5,
         (n1_response + n2_response) > 11) %>% 
  distinct()
goutput2[[3]] = output2 %>% 
  select(n1_response, n2_response, n3_response) %>% 
  filter(n1_response > 5,
         (n1_response + n2_response) > 11,
         (n1_response + n2_response + n3_response) > 17) %>% 
  distinct()
goutput2[[4]] = output2 %>% 
  select(n1_response, n2_response, n3_response, n4_response) %>% 
  filter(n1_response > 5,
         (n1_response + n2_response) > 11,
         (n1_response + n2_response + n3_response) > 17,
         (n1_response + n2_response + n3_response + n4_response) > 23) %>% 
  distinct()
  # goutput2[[i]] = output2 
  #   filter(output[[i]] > 5)
  # goutput2[[i+1]]
  #          (n1_response + n2_response) > 11,
  #          (n1_response + n2_response + n3_response) > 17,
  #          (n1_response + n2_response + n3_response + n4_response) > 23)

```

```{r}
prior1 = function(df = output1, null = 0.25, stage1n = 20, n1 = 6) {
  res = df %>% 
    unnest(data) %>% 
    mutate(pE1 = dbeta(null, n1_response/stage1n, (stage1n-n1_response)/stage1n),
           pS = dbeta(null+x, 25, 75)) %>% 
    filter(n1_response > n1-1)
  res1 = res %>%
    filter(pE1 > pS) %>%
    group_by(x) %>%
    mutate(alpha = 1 - length(x)/nrow(goutput1)) %>%
    select(x, alpha) %>%
    distinct() %>%
    filter(alpha < .2)
  return(res1)
}
```


```{r}
prior2 = function(df = output2, null = 0.25, stage1n = 20, stage2n = 40, n1 = 6, n2 = 12) {
  res = df %>% 
    unnest(data) %>% 
    mutate(pE1 = dbeta(null, n1_response/stage1n, (stage1n-n1_response)/stage1n),
           pE2 = dbeta(null, (n1_response+n2_response)/stage2n, (stage2n-n1_response-n2_response)/stage2n),
           pS = dbeta(null+x, 25, 75)) %>% 
    filter(n1_response > n1-1,
           (n1_response + n2_response) > n2-1)
  res2 = res %>%
    filter(pE2 > pS) %>%
    group_by(x) %>%
    mutate(alpha = 1 - length(x)/nrow(goutput2)) %>%
    select(x, alpha) %>%
    distinct() %>%
    filter(alpha < .2)
  return(res2)
}
```

```{r}
prior3 = function(df = output3, null = 0.25, stage1n = 20, stage2n = 40, stage3n = 60, n1 = 6, n2 = 12, n3 = 18) {
  res = df %>% 
    unnest(data) %>% 
    mutate(pE1 = dbeta(null, n1_response/stage1n, (stage1n-n1_response)/stage1n),
           pE2 = dbeta(null, (n1_response+n2_response)/stage2n, (stage2n-n1_response-n2_response)/stage2n),
           pE3 = dbeta(null, (n1_response + n2_response + n3_response)/stage3n, (stage3n-n1_response-n2_response-n3_response)/stage3n),
           pS = dbeta(null+x, 25, 75)) %>% 
    filter(n1_response > n1-1,
           (n1_response + n2_response) > n2-1,
           (n1_response + n2_response + n3_response) > n3-1)
  res3 = res %>%
    filter(pE3 > pS) %>%
    group_by(x) %>%
    mutate(alpha = 1 - length(x)/nrow(goutput3)) %>%
    select(x, alpha) %>%
    distinct() %>%
    filter(alpha < .2)
  return(res3)
}
```


```{r, cache = TRUE}
prior4 = function(df = output4, null = 0.25, stage1n = 20, stage2n = 40, stage3n = 60, stage4n = 71, n1 = 6, n2 = 12, n3 = 18, n4 = 24) {
  res = df %>% 
    unnest(data) %>% 
    mutate(pE1 = dbeta(null, n1_response/stage1n, (stage1n-n1_response)/stage1n),
           pE2 = dbeta(null, (n1_response+n2_response)/stage2n, (stage2n-n1_response-n2_response)/stage2n),
           pE3 = dbeta(null, (n1_response + n2_response + n3_response)/stage3n, (stage3n-n1_response-n2_response-n3_response)/stage3n),
           pE4 = dbeta(null, (n1_response + n2_response + n3_response + n4_response)/stage4n, (stage4n-n1_response-n2_response-n3_response-n4_response)/stage4n),
           pS = dbeta(null+x, 25, 75)) %>% 
    filter(n1_response > n1-1,
           (n1_response + n2_response) > n2-1,
           (n1_response + n2_response + n3_response) > n3-1,
           (n1_response + n2_response + n3_response + n4_response) > n4-1)
  res4 = res %>%
    filter(pE4 > pS) %>%
    group_by(x) %>%
    mutate(alpha = 1 - length(x)/nrow(goutput4)) %>%
    select(x, alpha) %>%
    distinct() %>%
    filter(alpha < .2)
  return(res4)
}
```

```{r}
prior1 = prior1()
prior2 = prior2()
prior3 = prior3()
prior4 = prior4()

prior1
prior2
prior3
prior4
```


```{r, echo = FALSE, eval = FALSE}
return(res)
}
res = prior4()

res %>% 
  filter(pE4>pS) %>% 
  group_by(x) %>% 
  mutate(alpha = 1 - length(x)/15/131) %>% 
  select(x, alpha) %>% 
  filter(alpha < 0.2) %>% 
  distinct()

# res %>% 
#   filter(pE1 > pS) %>% 
#   summarize(x = x, 
#             alpha = 1 - length(x)/n_distinct(n1_response, x)) %>% 
#   select(x, alpha) %>% 
#   distinct() %>% 
#   filter(alpha < 0.2)
# nrow(goutput2[[1]])

```


```{r, cache = TRUE}
# pair_df[[2]] = res %>%
  #   filter(pE2 > pS) %>%
  #   group_by(x) %>%
  #   mutate(alpha = 1 - length(x)/400) %>%
  #   select(x, alpha) %>%
  #   distinct() %>%
  #   filter(alpha < .2)
    
# }
  # for (i in 1:4) {
  #   pair_df[[i]] = res %>% 
  #     select(pE1:pE4, x, pS) %>% 
  #     filter(res[[i]] > pS) %>% 
  #     group_by(x) %>% 
  #     mutate(alpha = 1 - length(x)/) %>%
  #     select(x, alpha) %>%
  #     distinct() %>%
  #     filter(alpha < .2)
  # }
  # return(pair_df)
# }

#   dapair = NULL
#   for (i in 1:4){
#     dapair[[i]] = res %>%
#       filter(paste0("pE", i) > pS) %>%
#       group_by(x) %>%
#       mutate(alpha = 1 - length(x)/nrow(goutput2)) %>%
#       select(x, alpha) %>%
#       distinct() %>%
#       filter(alpha<0.2)
#   }
#     return(dapair)
# }

#   res = res %>%
#     filter(pE1 > pS) %>%
#     group_by(x) %>%
#     mutate(alpha = 1 - length(x)/nrow(goutput)) %>%
#     select(x, alpha) %>%
#     distinct() %>%
#     filter(alpha < .2)
#   return(res)
# }


# output %>% 
#   unnest(data)
```

```{r}
set.seed(1)
n_sim = 10e5
sum(rbeta(n_sim, shape1 = 6.5, shape2 = 15.5) > (rbeta(n_sim, shape1 = 25, shape2 = 75) + 0.109)) / n_sim
sum(rbeta(n_sim, shape1 = 12.5, shape2 = 29.5) > (rbeta(n_sim, shape1 = 25, shape2 = 75) + 0.109)) / n_sim
sum(rbeta(n_sim, shape1 = 18.5, shape2 = 43.5) > (rbeta(n_sim, shape1 = 25, shape2 = 75) + 0.109)) / n_sim
sum(rbeta(n_sim, shape1 = 24.5, shape2 = 57.5) > (rbeta(n_sim, shape1 = 25, shape2 = 75) + 0.109)) / n_sim
```

